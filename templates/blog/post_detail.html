{% extends 'base_brite_sidebar.html' %}
{% load static %}

{% block title %}{{ post.title }} - DCPlant Blog{% endblock %}

{% block extra_css %}
<style>
    .post-content {
        font-size: 1.1rem;
        line-height: 1.8;
    }
    .post-content img {
        max-width: 100%;
        height: auto;
        margin: 1rem 0;
    }
    .post-content h1, .post-content h2, .post-content h3 {
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    .post-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .author-info {
        border-left: 3px solid #007bff;
        padding-left: 1rem;
    }
    .comment-item {
        border-left: 2px solid #e9ecef;
        padding-left: 1rem;
        margin-left: 0;
    }
    .comment-item.reply {
        margin-left: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Post Header -->
        <article class="card mb-4">
            {% if post.featured_image %}
            <img src="{{ post.featured_image.url }}" class="card-img-top" alt="{{ post.title }}"
                 style="max-height: 400px; object-fit: cover;">
            {% endif %}
            
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        {% if post.category %}
                        <a href="{% url 'blog:post_list' %}?category={{ post.category.id }}" 
                           class="badge bg-info text-decoration-none mb-2">
                            {{ post.category.name }}
                        </a>
                        {% endif %}
                        
                        <h1 class="h2 mb-3">{{ post.title }}</h1>
                        
                        <div class="post-meta">
                            <span class="me-3">
                                <i class="bi bi-person"></i> 
                                {{ post.author.get_full_name|default:post.author.username }}
                            </span>
                            <span class="me-3">
                                <i class="bi bi-calendar3"></i> 
                                {% if post.published_at %}
                                    {{ post.published_at|date:"F d, Y" }}
                                {% else %}
                                    {{ post.created_at|date:"F d, Y" }}
                                {% endif %}
                            </span>
                            <span class="me-3">
                                <i class="bi bi-eye"></i> {{ post.views_count }} views
                            </span>
                            <span>
                                <i class="bi bi-chat"></i> {{ comments.count }} comments
                            </span>
                        </div>
                    </div>
                    
                    {% if user == post.author or user.is_staff %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{% url 'blog:post_edit' post.slug %}">
                                    <i class="bi bi-pencil me-2"></i>Edit
                                </a>
                            </li>
                            <li>
                                <form method="post" action="{% url 'blog:post_delete' post.slug %}"
                                      onsubmit="return confirm('Are you sure you want to delete this post?');">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-trash me-2"></i>Delete
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Post Content -->
                <div class="post-content mb-4">
                    {{ post.content|safe }}
                </div>
                
                <!-- Tags -->
                {% if post.tags %}
                <div class="mb-4">
                    <i class="bi bi-tags me-2"></i>
                    {% for tag in post.tags %}
                    <span class="badge bg-secondary me-1">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Like Button -->
                <div class="mb-4">
                    <button class="btn btn-outline-danger" id="likeBtn" onclick="toggleLike()">
                        <i class="bi bi-heart" id="likeIcon"></i>
                        <span id="likeCount">{{ post.likes_count }}</span> Likes
                    </button>
                </div>
                
                <hr>
                
                <!-- Author Info -->
                <div class="author-info mb-4">
                    <h5>About the Author</h5>
                    <p class="mb-0">
                        <strong>{{ post.author.get_full_name|default:post.author.username }}</strong>
                        {% if post.author.profile.professional_type %}
                        - {{ post.author.profile.get_professional_type_display }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </article>
        
        <!-- Comments Section -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Comments ({{ comments.count }})</h5>
            </div>
            <div class="card-body">
                <!-- Comment Form -->
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'blog:comment_add' post.slug %}" class="mb-4">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    <button type="submit" class="btn btn-primary mt-2">
                        <i class="bi bi-send"></i> Post Comment
                    </button>
                </form>
                {% else %}
                <p class="text-muted">Please <a href="{% url 'dashboard:login' %}">login</a> to comment.</p>
                {% endif %}
                
                <!-- Comments List -->
                <div class="comments-list">
                    {% for comment in comments %}
                    <div class="comment-item mb-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                                <span class="text-muted small">• {{ comment.created_at|timesince }} ago</span>
                            </div>
                            {% if user == comment.author or user.is_staff %}
                            <form method="post" action="{% url 'blog:comment_delete' comment.pk %}" 
                                  style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-link text-danger p-0">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        <p class="mb-2">{{ comment.content|linebreaks }}</p>
                        
                        <!-- Replies -->
                        {% for reply in comment.replies.all %}
                        <div class="comment-item reply mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ reply.author.get_full_name|default:reply.author.username }}</strong>
                                    <span class="text-muted small">• {{ reply.created_at|timesince }} ago</span>
                                </div>
                                {% if user == reply.author or user.is_staff %}
                                <form method="post" action="{% url 'blog:comment_delete' reply.pk %}" 
                                      style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            <p class="mb-0">{{ reply.content|linebreaks }}</p>
                        </div>
                        {% endfor %}
                        
                        {% if user.is_authenticated %}
                        <button class="btn btn-sm btn-link" onclick="showReplyForm({{ comment.pk }})">
                            <i class="bi bi-reply"></i> Reply
                        </button>
                        <div id="replyForm{{ comment.pk }}" style="display: none;" class="mt-2">
                            <form method="post" action="{% url 'blog:comment_add' post.slug %}">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comment.pk }}">
                                <textarea name="content" class="form-control" rows="2" required></textarea>
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Reply</button>
                                <button type="button" class="btn btn-sm btn-secondary mt-2" 
                                        onclick="hideReplyForm({{ comment.pk }})">Cancel</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted">No comments yet. Be the first to comment!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Related Posts -->
        {% if related_posts %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Related Posts</h5>
            </div>
            <div class="card-body">
                {% for related in related_posts %}
                <div class="mb-3">
                    <h6 class="mb-1">
                        <a href="{% url 'blog:post_detail' related.slug %}" class="text-decoration-none">
                            {{ related.title }}
                        </a>
                    </h6>
                    <small class="text-muted">
                        {{ related.published_at|date:"M d, Y" }}
                    </small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Post Stats -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Post Statistics</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-eye text-primary"></i> 
                        <strong>{{ post.views_count }}</strong> Views
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-heart text-danger"></i> 
                        <strong>{{ post.likes_count }}</strong> Likes
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-chat text-info"></i> 
                        <strong>{{ comments.count }}</strong> Comments
                    </li>
                    <li>
                        <i class="bi bi-clock text-success"></i> 
                        <strong>{{ post.content|wordcount }}</strong> Words
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let liked = false;

function toggleLike() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const action = liked ? 'unlike' : 'like';
    
    fetch(`/blog/admin/ajax/post/{{ post.slug }}/like/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('likeCount').textContent = data.likes_count;
            const icon = document.getElementById('likeIcon');
            if (data.liked) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                liked = true;
            } else {
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                liked = false;
            }
        }
    });
}

function showReplyForm(commentId) {
    document.getElementById(`replyForm${commentId}`).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById(`replyForm${commentId}`).style.display = 'none';
}
</script>
{% endblock %}